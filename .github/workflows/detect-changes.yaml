name: Detect Changes

on:
  workflow_call:
    inputs:
      artifact-name:
        description: "Name of the build artifact to use as source"
        required: true
        type: string
      force_package:
        description: "Force rebuild of a specific package (optional)"
        required: false
        type: string
        default: ""
    outputs:
      matrix:
        value: ${{ jobs.detect.outputs.matrix }}
      should_run:
        value: ${{ jobs.detect.outputs.should_run }}

jobs:
  detect:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-buildroot-glibc:20251206R1
      options: --platform linux/amd64
    outputs:
      matrix: ${{ steps.out.outputs.matrix }}
      should_run: ${{ steps.out.outputs.should_run }}

    steps:
      - name: Prep container
        run: |
          echo "/usr/libexec/chroot-git" >> "$GITHUB_PATH"
          # cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          xbps-install -Syu xbps
          xbps-install -yu
          xbps-install -y github-cli jq

      - uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact-name }}
          path: .

      - name: Unpack merged repo
        run: |
          mkdir -p /work
          bsdtar xzf source.tgz -C /work --strip-components=1

      - name: Identify new packages to build
        id: find-packages # out
        working-directory: /work
        env:
          GH_TOKEN: ${{ github.token }}
          SHA: ${{ github.sha }}
        run: |
          git config --global --add safe.directory /work

          latest_tag=$(gh release view --json tagName --jq '.tagName' --repo grvn/void-packages 2>/dev/null || echo "")

          if [ -z "$latest_tag" ]; then
            echo "No previous release found, using previous commit"
            if git rev-parse grvn/main~1 >/dev/null 2>&1; then
              latest_sha=$(git rev-list --max-count=1 grvn/main~1)
            else
              # First commit fallback
              latest_sha=$(git rev-list --max-parents=0 grvn/main)
            fi
          else
            latest_sha=$(git rev-list --max-count=1 "$latest_tag")
          fi

          echo "Latest Tag: ${latest_tag}"
          echo "Latest Tag SHA: ${latest_sha}"

          change=$(git diff-tree -r --no-renames --name-only --diff-filter=AM ${latest_sha} ${SHA} -- srcpkgs/** | cut -d/ -f2 | uniq)

          if [ -n "${{ inputs.force_package }}" ]; then
            change="$change ${{ inputs.force_package }}"
          fi

          if [ -z "$change" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" > etc/conf
            echo "$change" | xargs ./xbps-src sort-dependencies | jq -R | jq -cs | tee matrix.json
            echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT
          fi
