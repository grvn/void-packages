name: Build and Release Void Linux Packages

on:
  workflow_dispatch:
    inputs:
      force_package:
        description: "Force rebuild of a specific package (optional)"
        required: false
        default: ""
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - srcpkgs/**

jobs:
  prepare:
    uses: ./.github/workflows/merge_repos.yaml

  detect:
    needs: prepare
    uses: ./.github/workflows/detect_changes.yaml
    with:
      artifact-name: ${{ needs.prepare.outputs.artifact-name }}
      force_package: ${{ github.event.inputs.force_package }}

  build:
    needs: detect
    if: ${{ needs.detect.outputs.matrix != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect.outputs.matrix) }}
        arch:
          - x86_64
          - x86_64-musl
        include:
          - arch: x86_64
            libc: glibc
          - arch: x86_64-musl
            libc: musl
    uses: ./.github/workflows/build_package.yaml
    with:
      artifact-name: ${{ needs.prepare.outputs.artifact-name }}
      package: ${{ matrix.package }}
      arch: ${{ matrix.arch }}
      libc: ${{ matrix.libc }}

  repo_tree:
    needs: build
    if: ${{ needs.build.result == 'success' }}
    uses: ./.github/workflows/repotree.yaml

  index:
    needs: repo_tree
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
          - x86_64-musl
        include:
          - arch: x86_64
            libc: glibc
          - arch: x86_64-musl
            libc: musl
    uses: ./.github/workflows/index.yaml
    with:
      arch: ${{ matrix.arch }}
      libc: ${{ matrix.libc }}

  collect_indexed_arches:
    needs: index
    runs-on: ubuntu-latest
    outputs:
      arches: ${{ steps.collect.outputs.arches }}
    steps:
      - name: Collect arches with artifacts
        id: collect
        run: |
          arr=()
          for arch in x86_64 x86_64-musl aarch64 aarch64-musl; do
            produced="${{ needs.index.outputs[format('{0}.produced', arch)] }}"
            if [ "$produced" = "true" ]; then
              arr+=("\"$arch\"")
            fi
          done
          echo "arches=[$(IFS=,; echo "${arr[*]}")]" >> $GITHUB_OUTPUT


  sign:
    needs: collect_indexed_arches
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJson(needs.collect_indexed_arches.outputs.arches) }}
    uses: ./.github/workflows/sign.yaml
    with:
      arch: ${{ matrix.arch }}
    secrets: inherit

  diff:
    needs: sign
    uses: ./.github/workflows/diff_dashboard.yaml

  release:
    needs: diff
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download signed repo
        uses: actions/download-artifact@v7
        with:
          pattern: signed-repo-*
          merge-multiple: true
          path: repo

      - name: Download diff.md
        uses: actions/download-artifact@v7
        with:
          name: diff-md
          path: .

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: "Build ${{ github.sha }}"
          tag_name: build-${{ github.run_number }}-${{ github.sha }}
          draft: true
          body_path: diff.md
          files: repo/**
