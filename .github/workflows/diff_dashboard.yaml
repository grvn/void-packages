name: Diff Dashboard

on:
  workflow_call:

jobs:
  diff:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-buildroot-glibc:20251206R1
      options: --platform linux/amd64

    steps:
      - uses: actions/download-artifact@v7
        with:
          name: repo-tree
          path: .

      - uses: actions/download-artifact@v7
        with:
          pattern: signed-repo-*
          merge-multiple: true
          path: repo

      - name: Install tools
        run: |
          xbps-install -Syu xbps
          xbps-install -yu
          xbps-install -y xpkgdiff

      - name: Generate diff
        run: |
          echo "## ðŸ“¦ Package Changes (xpkgdiff)" > diff.md
          echo "" >> diff.md

          for arch in x86_64 x86_64-musl; do
            for newpkg in repo/${arch}/*.xbps; do
              [ -e "$newpkg" ] || continue
              base=$(basename "$newpkg")
              name=${base%-[0-9]*}
              oldpkg=$(ls oldrepo/${arch}/${name}-*.xbps 2>/dev/null || true)
              [ -n "$oldpkg" ] || continue

              diff=$(xpkgdiff "$oldpkg" "$newpkg" || true)
              if [ -n "$diff" ]; then
                echo "### ${name} (${arch})" >> diff.md
                echo '```' >> diff.md
                echo "$diff" >> diff.md
                echo '```' >> diff.md
                echo "" >> diff.md
              fi
            done
          done

      - uses: actions/upload-artifact@v6
        with:
          name: diff-md
          path: diff.md
