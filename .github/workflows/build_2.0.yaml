name: Build and Release Custom Void Linux Packages

env:
  # TAG: workflow-${{ github.run_number }}
  TAG: build-${{ github.run_number }}-${{ github.sha }}
  SHA: ${{ github.sha }}

on:
  workflow_dispatch:
    inputs:
      force_package:
        description: "Force rebuild of a specific package (optional)"
        required: false
        default: ""
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - srcpkgs/**

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------
# 1. PREPARE — merge repo into void-packages and archive
# ------------------------------------------------------------
jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          repository: void-linux/void-packages
          ref: master

      - name: Merge this repository into void-linux/void-packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "*"

          git remote add -f grvn https://github.com/grvn/void-packages.git
          git merge --no-commit --strategy-option=theirs --allow-unrelated-histories -Xignore-space-change grvn/main

          find -mindepth 1 -maxdepth 1 -exec tar czf source.tgz {} \+

      - name: Upload prepared merged repo
        uses: actions/upload-artifact@v6
        with:
          name: source
          path: source.tgz
          retention-days: 1
          # include-hidden-files: true

# ------------------------------------------------------------
# 2. INIT — detect changed packages and produce matrix
# ------------------------------------------------------------
  init:
    needs: prepare
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    container:
      image: ghcr.io/void-linux/void-buildroot-glibc:20251206R1
      options: --platform linux/amd64
    outputs:
      matrix: ${{ steps.find-packages.outputs.matrix }}

    steps:
      - name: Prep container
        run: |
          echo "/usr/libexec/chroot-git" >> "$GITHUB_PATH"
          # cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          xbps-install -Syu xbps
          xbps-install -yu
          xbps-install -y github-cli jq

      - name: Download prepared merged repo
        uses: actions/download-artifact@v7
        with:
          name: source

      - name: Unpack prepared repo
        run: |
          mkdir -p /work
          bsdtar xzf source.tgz -C /work --strip-components=1

      - name: Identify new packages to build
        id: find-packages
        working-directory: /work
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global --add safe.directory /work

          latest_tag=$(gh release view --json tagName --jq '.tagName' --repo grvn/void-packages 2>/dev/null || echo "")

          if [ -z "$latest_tag" ]; then
            echo "No previous release found, using previous commit"
            if git rev-parse grvn/main~1 >/dev/null 2>&1; then
              latest_sha=$(git rev-list --max-count=1 grvn/main~1)
            else
              # First commit fallback
              latest_sha=$(git rev-list --max-parents=0 grvn/main)
            fi
          else
            latest_sha=$(git rev-list --max-count=1 "$latest_tag")
          fi

          echo "Latest Tag: ${latest_tag}"
          echo "Latest Tag SHA: ${latest_sha}"

          change=$(git diff-tree -r --no-renames --name-only --diff-filter=AM ${latest_sha} ${SHA} -- 'srcpkgs/**' | cut -d/ -f2 | uniq)

          if [ -n "${{ github.event.inputs.force_package }}" ]; then
            change="$change ${{ github.event.inputs.force_package }}"
          fi

          if [ -z "$change" ]; then
            echo "[]" > /tmp/matrix.json
          else
            echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" > etc/conf
            echo "$change" | xargs ./xbps-src sort-dependencies | jq -R | jq -cs | tee /tmp/matrix.json
          fi

          echo "matrix=$(cat /tmp/matrix.json)" >> $GITHUB_OUTPUT

# ------------------------------------------------------------
# 3. BUILD — parallel builds, isolated dirs, upload artifacts
# ------------------------------------------------------------
  build:
    needs: init
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && needs.init.outputs.matrix != '[]' }}
    permissions: write-all
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.init.outputs.matrix) }}
        arch:
          - x86_64
          - x86_64-musl
        include:
          - arch: x86_64
            libc: glibc
          - arch: x86_64-musl
            libc: musl

    steps:
      - uses: actions/download-artifact@v6
        with:
          name: source

      - run: tar xzf source.tgz --strip-components=1

      - name: Build in void-linux ${{ matrix.libc }} container
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/void-linux/void-${{ matrix.libc }}-full:20250616R1
          options: -v ${{ github.workspace }}:/work -v /dev:/dev --platform linux/amd64 --privileged -e GH_TOKEN=${{ github.token }}
          run: |
            mkdir -p /etc/xbps.d
            cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
            sed -i 's|repo-default|repo-ci|g' /etc/xbps.d/*-repository-*.conf
            xbps-install -Syu xbps
            xbps-install -yu
            xbps-install -y sudo bash curl git jq zip unzip github-cli
            useradd -G xbuilder -M builder
            cd /work
            chown -R builder:builder . &&
            sudo -Eu builder common/travis/set_mirror.sh &&
            sudo -Eu builder common/travis/prepare.sh &&
            common/travis/fetch-xtools.sh

            mkdir -p hostdir/binpkgs

            gh release download --pattern "${{ matrix.package }}*${{ matrix.arch }}*.xbps" --dir hostdir/binpkgs --repo grvn/void-packages || true
            if [ "$ARCH" = x86_64 ]; then
              rm --force hostdir/binpkgs/*x86_64-musl*
            fi
            rm --force hostdir/binpkgs/*.xbps.sig2

            echo "${{ matrix.package }}" > /tmp/templates
            sudo -Eu builder common/travis/build.sh

      - name: Upload logs on failure
        if: failure()
        id: uploadlogs
        uses: actions/upload-artifact@v6
        with:
          name: logs-${{ matrix.package }}-${{ matrix.libc }}
          path: builddir/.xbps-src*/${{ matrix.package }}/*.log
          retention-days: 7

      - name: Add failure to summary
        if: failure()
        run: |
          {
            echo "### ❌ Package Build Failed"
            echo ""
            echo "| Package | Libc | Logs |"
            echo "|---------|------|------|"
            echo "| \`${{ matrix.package }}\` | \`${{ matrix.libc }}\` | [View logs](${{ steps.uploadlogs.outputs.artifact-url }}) |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload built package
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: void-${{ matrix.package }}-${{ matrix.libc }}
          path: hostdir/binpkgs/*.xbps

      # - name: Restore distfiles cache
      #   working-directory: /work
      #   env:
      #     GITHUB_TOKEN: ${{ github.token }}
      #   run: |
      #     .github/scripts/gh-cache-restore.sh \
      #       "distfiles-${{ matrix.libc }}-${{ matrix.arch }}-${{ hashFiles('srcpkgs/**/template') }}" \
      #       /work/hostdir/distfiles

      # - name: Save distfiles cache
      #   env:
      #     GITHUB_TOKEN: ${{ github.token }}
      #   run: |
      #     .github/scripts/gh-cache-save.sh "distfiles-${{ matrix.libc }}" /work/hostdir/distfiles

# ------------------------------------------------------------
# 4. RELEASE — merge artifacts, sign repo, publish release
# ------------------------------------------------------------
  newrelease:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.ref == 'refs/heads/main' && needs.build.result == 'success' }}
    container:
      image: ghcr.io/void-linux/void-buildroot-glibc:20251206R1
      options: --platform linux/amd64

    steps:
      - name: Download built packages
        uses: actions/download-artifact@v7
        with:
          path: /repo
          pattern: void-*
          merge-multiple: true

      - name: Clean & sign
        working-directory: /repo
        env:
          PRIVKEY: ${{ secrets.PRIV_KEY }}
          XBPS_PASSPHRASE: ${{ secrets.SIGN_PASS }}
        run: |
          xbps-rindex --remove-obsoletes ${PWD}
          printf "%s\n" "${PRIVKEY}" > key.pem
          xbps-rindex --privkey key.pem --sign --signedby "${{ github.repository }}-github-actions" --verbose ${PWD}
          xbps-rindex --privkey key.pem --sign-pkg --verbose ${PWD}/*.xbps
          rm -f key.pem
          xbps-rindex --clean ${PWD}

      - name: checksum
        working-directory: /repo
        run: |
          rm -rf *.sha256sum *.sha512sum
          for file in *.xbps; do
            sha256sum "${file}" | cut -d ' ' -f1 > "${file}.sha256sum"
            sha512sum "${file}" | cut -d ' ' -f1 > "${file}.sha512sum"
          done

      - name: Create new release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "Build ${{ github.sha }}"
          tag_name: ${{ env.TAG }}
          files: /repo/*
