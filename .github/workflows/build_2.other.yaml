name: Voidâ€‘style CI

on:
  workflow_dispatch:
    inputs:
      force_package:
        description: "Force rebuild of a specific package (optional)"
        required: false
        default: ""
  # push:
  #   branches: [ main ]
  #   paths: [ 'srcpkgs/**' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          ref: master

      - name: Merge this repository into void-linux/void-packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "*"

          git remote add -f grvn https://github.com/grvn/void-packages.git
          git merge --no-commit --strategy-option=theirs --allow-unrelated-histories -Xignore-space-change grvn/main

          find -mindepth 1 -maxdepth 1 -exec tar czf source.tgz {} \+

      - name: Upload prepared merged repo
        uses: actions/upload-artifact@v4
        with:
          name: source
          path: source.tgz
          retention-days: 1
          # include-hidden-files: true

  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        config:
          - { arch: x86_64,       host: x86_64,      libc: glibc, platform: linux/amd64, test: 1 }
          - { arch: x86_64-musl,  host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 1 }

    container:
      image: ghcr.io/void-linux/void-${{ matrix.config.libc }}-full:20250616R1
      options: --platform ${{ matrix.config.platform }} --privileged
      volumes:
        - /dev:/dev
      env:
        ARCH: '${{ matrix.config.arch }}'
        BOOTSTRAP: '${{ matrix.config.host }}'
        TEST: '${{ matrix.config.test }}'

    steps:
      - name: Prepare container
        run: |
          mkdir -p /etc/xbps.d
          cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          sed -i 's|repo-default|repo-ci|g' /etc/xbps.d/*-repository-*.conf
          xbps-install -Syu xbps
          xbps-install -yu
          xbps-install -y sudo bash curl git
          useradd -G xbuilder -M builder

      - name: Download prepared merged repo
        uses: actions/download-artifact@v4
        with:
          name: source

      - name: Unpack prepared repo
        run: |
          mkdir -p /work
          bsdtar xzf source.tgz -C /work --strip-components=1

      - name: Prepare masterdir
        working-directory: /work
        run: |
          chown -R builder:builder .
          sudo -Eu builder common/travis/set_mirror.sh
          sudo -Eu builder common/travis/prepare.sh
          common/travis/fetch-xtools.sh

      - name: Find changed templates
        working-directory: /work
        run: sudo -Eu builder common/travis/changed_templates.sh

      - name: Build packages
        working-directory: /work
        run: sudo -Eu builder common/travis/build.sh "$BOOTSTRAP" "$ARCH" "$TEST"

      - name: Show files
        working-directory: /work
        run: sudo -Eu builder common/travis/show_files.sh "$BOOTSTRAP" "$ARCH"

      - name: Compare to previous
        working-directory: /work
        run: sudo -Eu builder common/travis/xpkgdiff.sh "$BOOTSTRAP" "$ARCH"

      - name: Check file conflicts
        working-directory: /work
        if: matrix.config.arch == 'x86_64'
        run: |
          if [ -s /tmp/templates ]; then
            export XDG_CACHE_HOME="$PWD/.cache"
            sudo -Eu builder xlocate -S
            sudo -Eu builder common/scripts/lint-conflicts
          fi

      - name: Verify repository state
        working-directory: /work
        run: |
          mkdir -p /check-install
          chown builder:builder /check-install
          sudo -Eu builder common/travis/check-install.sh "$BOOTSTRAP" "$ARCH"
